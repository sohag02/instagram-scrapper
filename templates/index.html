<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instagram Scraper Pro ‚Äî Modern UI</title>

  <style>
    /* ==================== THEME & DESIGN SYSTEM ==================== */
    :root {
      --sidebar-w: 260px;
      --gap: 18px;
      --radius: 14px;
      --muted: #8a8a8a;
      --surface: #ffffff;
      --glass: rgba(255, 255, 255, 0.7);
      --accent-start: #f58529;
      --accent-mid: #dd2a7b;
      --accent-end: #515bd4;
      --gradient: linear-gradient(135deg, var(--accent-start), var(--accent-mid), var(--accent-end));
      --shadow-sm: 0 4px 18px rgba(16, 24, 40, 0.06);
      --shadow-md: 0 8px 30px rgba(16, 24, 40, 0.08);
      --glass-border: rgba(255, 255, 255, 0.6);
      --transition: 220ms cubic-bezier(.17, .84, .44, 1);
      --max-width: 1200px;
      --text: #222;
      --accent-text: #fff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    html,
    body {
      height: 100%
    }

    body {
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f3f6fb 0%, #fbfbfd 100%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      display: flex;
      min-height: 100vh;
    }

    /* ==================== SIDEBAR ==================== */
    .sidebar {
      width: var(--sidebar-w);
      min-width: var(--sidebar-w);
      background: var(--gradient);
      color: var(--accent-text);
      padding: 26px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      border-top-right-radius: 22px;
      border-bottom-right-radius: 22px;
      box-shadow: var(--shadow-md);
      position: fixed;
      left: 16px;
      top: 16px;
      bottom: 16px;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 4px;
    }

    .brand .logo {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }

    .brand .title {
      font-weight: 700;
      font-size: 1.05rem;
      line-height: 1;
      color: var(--accent-text)
    }

    .brand .subtitle {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.85);
      opacity: 0.95
    }

    nav.nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 6px;
    }

    .nav a {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      color: rgba(255, 255, 255, 0.95);
      text-decoration: none;
      font-weight: 600;
      transition: var(--transition);
      cursor: pointer;
    }

    .nav a .icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: rgba(255, 255, 255, 0.06)
    }

    .nav a:hover {
      transform: translateX(6px);
      background: rgba(255, 255, 255, 0.12)
    }

    .nav a.active {
      background: rgba(255, 255, 255, 0.18);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06)
    }

    .spacer {
      flex: 1
    }

    .sidebar-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .small {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.85)
    }

    /* ==================== MAIN LAYOUT ==================== */
    .container {
      margin-left: calc(var(--sidebar-w) + 34px);
      padding: 28px;
      width: 100%;
      max-width: calc(var(--max-width) + var(--sidebar-w));
    }

    header.topbar {
      display: flex;
      align-items: center;
      gap: 16px;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .searchbar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 12px;
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      min-width: 420px;
    }

    .searchbar input {
      border: none;
      outline: none;
      font-size: 14px;
      color: var(--text);
      background: transparent;
      width: 100%;
    }

    .actions {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .btn {
      padding: 10px 14px;
      border-radius: 10px;
      border: none;
      font-weight: 700;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 32px rgba(0, 0, 0, 0.1)
    }

    .btn-primary {
      background: var(--gradient);
      color: var(--accent-text);
      box-shadow: 0 8px 28px rgba(81, 91, 212, 0.12)
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(16, 24, 40, 0.06);
      color: var(--text)
    }

    .btn-danger {
      background: #ff4757;
      color: #fff
    }

    .btn-success {
      background: #0f6b2e;
      color: #fff
    }

    /* ==================== GRID & CARDS ==================== */
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: var(--gap);
      align-items: stretch;
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow-sm);
    }

    .kpi {
      grid-column: span 3;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kpi .value {
      font-size: 1.6rem;
      font-weight: 800
    }

    .kpi .label {
      font-size: 13px;
      color: var(--muted);
      font-weight: 700
    }

    .chart-card {
      grid-column: span 6;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .recent-tasks {
      grid-column: span 3;
      min-height: 120px;
      overflow: auto
    }

    /* ==================== WORK AREA ==================== */
    .work {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 18px;
    }

    .table-wrap {
      background: var(--surface);
      border-radius: 12px;
      padding: 12px;
      box-shadow: var(--shadow-sm);
      overflow: auto
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px
    }

    thead th {
      text-align: left;
      padding: 12px 10px;
      background: #fbfbfb;
      border-bottom: 1px solid #f1f3f6;
      color: var(--muted);
      font-weight: 700;
    }

    tbody td {
      padding: 12px 10px;
      border-bottom: 1px solid #f6f7f9
    }

    tbody tr:hover {
      background: #f8f9fa
    }

    .status {
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px
    }

    .s-success {
      background: #e6f7ee;
      color: #0f6b2e
    }

    .s-running {
      background: #eef3ff;
      color: #1744a2
    }

    .s-pending {
      background: #fff7e6;
      color: #7a5200
    }

    .s-failed {
      background: #ffecec;
      color: #a52222
    }

    .s-completed {
      background: #e6f7ee;
      color: #0f6b2e
    }

    /* action icons */
    .actions-row {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .icon-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      background: #fbfbfb;
      border: 1px solid rgba(16, 24, 40, 0.03);
      cursor: pointer;
      transition: var(--transition)
    }

    .icon-btn:hover {
      background: #f1f3f6;
      transform: scale(1.1)
    }

    /* ==================== MODALS & FORMS ==================== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(6, 7, 12, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .modal {
      width: 720px;
      max-width: 90vw;
      background: var(--surface);
      border-radius: 12px;
      padding: 22px;
      box-shadow: var(--shadow-md);
      max-height: 90vh;
      overflow-y: auto
    }

    .modal h3 {
      margin-bottom: 10px
    }

    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px
    }

    .form-row .col {
      flex: 1
    }

    .input,
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid rgba(16, 24, 40, 0.06);
      background: #fff;
      font-family: inherit;
      font-size: 14px
    }

    textarea {
      min-height: 100px;
      resize: vertical
    }

    .small-muted {
      font-size: 13px;
      color: var(--muted)
    }

    /* Page sections */
    .page-section {
      display: none
    }

    .page-section.active {
      display: block
    }

    /* Account cards */
    .account-card {
      background: linear-gradient(135deg, #fff, #fbfbfb);
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(16, 24, 40, 0.06);
    }

    .account-card .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .account-card .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .account-card .stat {
      text-align: center;
      padding: 8px;
      background: #fff;
      border-radius: 8px;
    }

    /* Task detail view */
    .task-detail {
      padding: 20px
    }

    .task-detail .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .data-preview {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 13px;
      max-height: 400px;
      overflow: auto
    }

    /* Settings */
    .settings-group {
      margin-bottom: 24px
    }

    .settings-group h4 {
      margin-bottom: 12px;
      font-size: 16px
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid rgba(16, 24, 40, 0.06);
    }

    /* Toggle switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background: var(--accent-start);
    }

    input:checked+.slider:before {
      transform: translateX(24px);
    }

    /* ==================== EMPTY STATES ==================== */
    .empty {
      padding: 36px;
      text-align: center;
      color: var(--muted);
      border-radius: 10px;
      background: linear-gradient(180deg, #ffffff, #fbfbfb)
    }

    /* ==================== RESPONSIVE ==================== */
    @media(max-width:1150px) {
      .container {
        margin-left: calc(var(--sidebar-w) + 20px)
      }

      .kpi {
        grid-column: span 4
      }

      .chart-card {
        grid-column: span 8
      }

      .recent-tasks {
        grid-column: span 12
      }

      .work {
        grid-template-columns: 1fr
      }
    }

    @media(max-width:820px) {
      .searchbar {
        min-width: unset;
        width: 100%
      }

      .sidebar {
        position: fixed;
        left: 10px;
        top: 10px;
        bottom: 10px;
        width: 72px;
        min-width: 72px;
        padding: 12px
      }

      .brand .title,
      .brand .subtitle,
      .nav a span,
      .small {
        display: none
      }

      .container {
        margin-left: calc(72px + 20px);
        padding: 16px
      }
    }

    @media(max-width:520px) {
      .sidebar {
        display: none
      }

      .container {
        margin-left: 0;
        padding: 12px
      }

      header.topbar {
        flex-direction: column;
        align-items: stretch;
        gap: 12px
      }

      .work {
        display: block
      }

      .actions {
        flex-wrap: wrap
      }
    }

    /* subtle animations */
    .fade-in {
      animation: fadeIn .36s ease both
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: none
      }
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar fade-in" aria-label="Main navigation">
    <div class="brand">
      <div class="logo" aria-hidden>
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
          style="filter: drop-shadow(0 6px 10px rgba(0,0,0,0.08))">
          <rect x="3" y="3" width="18" height="18" rx="5" fill="white" />
          <path d="M12 7.7a4.3 4.3 0 100 8.6 4.3 4.3 0 000-8.6z" fill="#515bd4" />
          <circle cx="17.5" cy="6.5" r="1.2" fill="#dd2a7b" />
        </svg>
      </div>
      <div>
        <div class="title">Instagram Scraper</div>
      </div>
    </div>

    <nav class="nav" role="navigation" aria-label="Primary">
      <a class="active" data-section="dashboard"><span class="icon">üìä</span><span>Dashboard</span></a>
      <a data-section="scraper"><span class="icon">üîç</span><span>Scraper</span></a>
      <a data-section="accounts"><span class="icon">üë•</span><span>Accounts</span></a>
      <a data-section="tasks"><span class="icon">üìã</span><span>Tasks</span></a>
      <a data-section="settings"><span class="icon">‚öôÔ∏è</span><span>Settings</span></a>
    </nav>

    <div class="spacer" aria-hidden></div>

    <div class="sidebar-footer">
      <div class="small">v1.0 ‚Ä¢ December 2025</div>
    </div>
  </aside>

  <!-- MAIN CONTAINER -->
  <main class="container" role="main">

    <!-- DASHBOARD PAGE -->
    <div id="page-dashboard" class="page-section active">
      <header class="topbar">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="searchbar" role="search">
            <svg width="18" height="18" viewBox="0 0 24 24" style="opacity:0.6">
              <circle cx="11" cy="11" r="8" stroke="#333" stroke-width="2" fill="none" />
              <path d="M21 21l-4.35-4.35" stroke="#333" stroke-width="2" />
            </svg>
            <input id="globalSearch" placeholder="Search username, hashtag or task..." />
          </div>
          <div class="small-muted" style="padding-left:8px">Quick filters:</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-ghost" data-filter="all">All</button>
            <button class="btn btn-ghost" data-filter="running">Running</button>
            <button class="btn btn-ghost" data-filter="completed">Completed</button>
          </div>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="newTaskBtn">‚ûï New Task</button>
          <button class="btn" id="newAccountBtn" style="background:#fff;border:1px solid rgba(16,24,40,0.06)">üë§
            Account</button>
        </div>
      </header>

      <!-- KPI GRID -->
      <section class="grid" aria-label="Summary metrics">
        <div class="kpi card fade-in">
          <div class="label small-muted">Total Accounts</div>
          <div class="value" id="kpiAccounts">0</div>
          <div class="small-muted">Connected Instagram accounts</div>
        </div>

        <div class="kpi card fade-in">
          <div class="label small-muted">Active Tasks</div>
          <div class="value" id="kpiActive">0</div>
          <div class="small-muted">Currently running tasks</div>
        </div>

        <div class="kpi card fade-in">
          <div class="label small-muted">Completed</div>
          <div class="value" id="kpiCompleted">0</div>
          <div class="small-muted">Tasks finished</div>
        </div>

        <div class="kpi card fade-in">
          <div class="label small-muted">Total Tasks</div>
          <div class="value" id="kpiTotal">0</div>
          <div class="small-muted">All time tasks</div>
        </div>
      </section>

      <!-- WORK AREA -->
      <section class="work">
        <div>
          <div class="table-wrap card fade-in">
            <div
              style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:8px">
              <div style="font-weight:800">Scraper Results</div>
              <div style="display:flex;gap:8px;align-items:center">
                <select id="rowsPerPage" style="padding:8px;border-radius:8px;border:1px solid rgba(16,24,40,0.06)">
                  <option value="5">5 rows</option>
                  <option value="10" selected>10 rows</option>
                  <option value="20">20 rows</option>
                </select>
                <button class="btn btn-ghost" id="refreshBtn">üîÑ Refresh</button>
              </div>
            </div>

            <div style="overflow:auto">
              <table id="resultsTable">
                <thead>
                  <tr>
                    <th style="width:60px">#</th>
                    <th>Target</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th style="width:140px">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
              <div class="small-muted" id="tableInfo">Showing 0 of 0</div>
              <div style="display:flex;gap:8px">
                <button class="btn btn-ghost" id="prevPage">‚Üê Prev</button>
                <button class="btn btn-ghost" id="nextPage">Next ‚Üí</button>
              </div>
            </div>
          </div>
        </div>

        <aside style="min-width:300px">
          <!-- CREATE TASK -->
          <div class="card fade-in">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
              <div style="font-weight:800">Create Task</div>
              <div class="small-muted">Quick</div>
            </div>

            <div style="display:flex;flex-direction:column;gap:10px">
              <select id="quickTaskType" class="input">
                <option value="profile">Profile Info</option>
                <option value="posts">Profile Posts</option>
                <option value="hashtag">Hashtag Posts</option>
                <option value="followers">Followers</option>
                <option value="following">Following</option>
                <option value="comments">Post Comments</option>
                <option value="likes">Post Likes</option>
              </select>

              <input id="quickTarget" class="input" placeholder="username or hashtag (no # or @)" />
              <input id="quickMax" class="input" type="number" min="1" max="1000" value="50" placeholder="Max items" />

              <div style="display:flex;gap:8px">
                <button class="btn btn-primary" id="createQuick">üöÄ Start</button>
                <button class="btn btn-ghost" id="openFullTask">Advanced</button>
              </div>
            </div>

            <div class="small-muted">Tip: Use hashtag tasks for exploring trends</div>
          </div>

          <div style="height:18px"></div>

          <!-- RECENT TASKS -->
          <div class="recent-tasks card fade-in" style="grid-column: span 4; margin-bottom: 20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div style="font-weight:800">Recent Tasks</div>
              <div class="small-muted">Live</div>
            </div>
            <div id="recentList"
              style="display:flex;flex-direction:column;gap:10px;max-height:220px;overflow:auto;padding-right:6px">
            </div>
          </div>

          <!-- ACCOUNT STATUS -->
          <div class="card fade-in">
            <div style="font-weight:800;margin-bottom:10px">Account Status</div>
            <div id="accountsPanel" class="small-muted">Loading...</div>
            <div style="height:12px"></div>
            <div style="display:flex;gap:8px">
              <button class="btn btn-primary" id="manageAccounts">Manage</button>
              <button class="btn btn-ghost" id="addAccount">‚ûï Add</button>
            </div>
          </div>
        </aside>
      </section>
    </div>

    <!-- SCRAPER PAGE -->
    <div id="page-scraper" class="page-section">
      <header class="topbar">
        <div>
          <h2 style="margin:0;font-size:1.8rem">üîç Scraper Dashboard</h2>
          <p class="small-muted" style="margin:8px 0 0 0">Create and manage scraping tasks</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('modalBackdrop')">‚ûï New Scraping Task</button>
        </div>
      </header>

      <div class="grid">
        <div class="card" style="grid-column:span 4">
          <h4 style="margin:0 0 16px 0">üìä Profile Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Extract profile information including followers, following,
            bio, and posts</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input id="profileUsername" class="input" placeholder="Enter username" />
            <button class="btn btn-primary" onclick="quickScrape('profile')">Scrape Profile</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 4">
          <h4 style="margin:0 0 16px 0">üì∏ Posts Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Get posts from a specific profile with images and captions
          </p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input id="postsUsername" class="input" placeholder="Enter username" />
            <input id="postsMax" class="input" type="number" value="20" min="1" max="100" placeholder="Max posts" />
            <button class="btn btn-primary" onclick="quickScrape('posts')">Scrape Posts</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 4">
          <h4 style="margin:0 0 16px 0">#Ô∏è‚É£ Hashtag Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Find posts by hashtag for trend analysis</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <input id="hashtagTag" class="input" placeholder="Enter hashtag (no #)" />
            <input id="hashtagMax" class="input" type="number" value="30" min="1" max="100" placeholder="Max posts" />
            <button class="btn btn-primary" onclick="quickScrape('hashtag')">Scrape Hashtag</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <h4 style="margin:0 0 16px 0">üë• Followers Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Extract follower list from any public profile</p>
          <div style="display:flex;gap:10px">
            <input id="followersUsername" class="input" placeholder="Enter username" style="flex:1" />
            <input id="followersMax" class="input" type="number" value="100" min="1" max="500" placeholder="Max"
              style="width:100px" />
            <button class="btn btn-primary" onclick="quickScrape('followers')">Start</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <h4 style="margin:0 0 16px 0">üí¨ Comments Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Extract comments and commenters from Instagram posts</p>
          <div style="display:flex;gap:10px">
            <input id="commentsUrl" class="input" placeholder="Post URL" style="flex:1" />
            <input id="commentsMax" class="input" type="number" value="100" min="1" max="500" placeholder="Max"
              style="width:100px" />
            <button class="btn btn-primary" onclick="quickScrape('comments')">Start</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <h4 style="margin:0 0 16px 0">‚ù§Ô∏è Likes Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Get list of users who liked a specific post</p>
          <div style="display:flex;gap:10px">
            <input id="likesUrl" class="input" placeholder="Post URL" style="flex:1" />
            <input id="likesMax" class="input" type="number" value="200" min="1" max="1000" placeholder="Max"
              style="width:100px" />
            <button class="btn btn-primary" onclick="quickScrape('likes')">Start</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <h4 style="margin:0 0 16px 0">üÜî FBID Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Enrich data with FBID from previously scraped profiles</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <div style="display:flex;gap:10px">
              <select id="fbidSourceTask" class="input" style="flex:1">
                <option value="">Select a previous task...</option>
              </select>
              <input id="fbidQty" class="input" type="number" min="1" placeholder="Qty (optional)"
                style="width:120px" />
            </div>
            <button class="btn btn-primary" onclick="startFbidScraper()">Start FBID Enrichment</button>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <h4 style="margin:0 0 16px 0">üîÑ Batch Scraper</h4>
          <p class="small-muted" style="margin-bottom:16px">Scrape multiple profiles at once (one per line)</p>
          <div style="display:flex;flex-direction:column;gap:10px">
            <textarea id="batchUsernames" class="input" placeholder="username1&#10;username2&#10;username3"></textarea>
            <button class="btn btn-primary" onclick="batchScrape()">Start Batch Scrape</button>
          </div>
        </div>
      </div>

      <div style="height:24px"></div>

      <div class="card">
        <h4 style="margin:0 0 16px 0">‚ö° Recent Scraping Activity</h4>
        <div id="scraperActivity">
          <div class="empty">No recent scraping activity</div>
        </div>
      </div>
    </div>

    <!-- ACCOUNTS PAGE -->
    <div id="page-accounts" class="page-section">
      <header class="topbar">
        <div>
          <h2 style="margin:0;font-size:1.8rem">üë• Account Management</h2>
          <p class="small-muted" style="margin:8px 0 0 0">Manage your Instagram accounts for scraping</p>
        </div>
        <div class="actions">
          <button class="btn btn-primary" onclick="openModal('modalAccount')">‚ûï Add Account</button>
          <button class="btn btn-ghost" onclick="refreshAccounts()">üîÑ Refresh</button>
        </div>
      </header>

      <div id="accountsList"></div>
    </div>

    <!-- TASKS PAGE -->
    <div id="page-tasks" class="page-section">
      <header class="topbar">
        <div>
          <h2 style="margin:0;font-size:1.8rem">üìã All Tasks</h2>
          <p class="small-muted" style="margin:8px 0 0 0">View and manage all scraping tasks</p>
        </div>
        <div class="actions">
          <select id="taskFilterStatus" class="input" style="width:auto" onchange="filterTasks()">
            <option value="all">All Tasks</option>
            <option value="pending">Pending</option>
            <option value="running">Running</option>
            <option value="completed">Completed</option>
            <option value="failed">Failed</option>
          </select>
          <button class="btn btn-ghost" onclick="refreshTasks()">üîÑ Refresh</button>
        </div>
      </header>

      <div class="card">
        <div style="overflow:auto">
          <table id="tasksTable">
            <thead>
              <tr>
                <th style="width:60px">#</th>
                <th>Target</th>
                <th>Type</th>
                <th>Status</th>
                <th>Account</th>
                <th>Created</th>
                <th style="width:180px">Actions</th>
              </tr>
            </thead>
            <tbody id="tasksTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="page-section">
      <header class="topbar">
        <div>
          <h2 style="margin:0;font-size:1.8rem">‚öôÔ∏è Settings</h2>
          <p class="small-muted" style="margin:8px 0 0 0">Configure scraper behavior and preferences</p>
        </div>
        <div class="actions">
          <button class="btn btn-success" onclick="saveSettings()">üíæ Save Settings</button>
        </div>
      </header>

      <div class="grid">
        <div class="card" style="grid-column:span 6">
          <div class="settings-group">
            <h4>üîß Scraping Configuration</h4>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Max Posts Per Profile</div>
                <div class="small-muted">Maximum number of posts to scrape from a profile</div>
              </div>
              <input type="number" id="maxPosts" class="input" value="50" min="1" max="1000" style="width:100px" />
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Max Followers to Scrape</div>
                <div class="small-muted">Maximum followers to extract per profile</div>
              </div>
              <input type="number" id="maxFollowers" class="input" value="100" min="1" max="5000" style="width:100px" />
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Request Delay (seconds)</div>
                <div class="small-muted">Delay between requests to avoid detection</div>
              </div>
              <input type="number" id="requestDelay" class="input" value="3" min="1" max="10" style="width:100px" />
            </div>
          </div>

          <div class="settings-group">
            <h4>üîÑ Account Rotation</h4>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Tasks Per Account</div>
                <div class="small-muted">Number of tasks before switching accounts</div>
              </div>
              <input type="number" id="tasksPerAccount" class="input" value="5" min="1" max="20" style="width:100px" />
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Cooldown Time (minutes)</div>
                <div class="small-muted">Rest period for each account after use</div>
              </div>
              <input type="number" id="cooldownTime" class="input" value="5" min="1" max="60" style="width:100px" />
            </div>
          </div>
        </div>

        <div class="card" style="grid-column:span 6">
          <div class="settings-group">
            <h4>üéØ Advanced Options</h4>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Headless Mode</div>
                <div class="small-muted">Run browser in background (recommended for servers)</div>
              </div>
              <label class="switch">
                <input type="checkbox" id="headlessMode" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Auto-Retry Failed Tasks</div>
                <div class="small-muted">Automatically retry failed scraping tasks</div>
              </div>
              <label class="switch">
                <input type="checkbox" id="autoRetry" />
                <span class="slider"></span>
              </label>
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Save Screenshots</div>
                <div class="small-muted">Save screenshots during scraping for debugging</div>
              </div>
              <label class="switch">
                <input type="checkbox" id="saveScreenshots" />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="settings-group">
            <h4>üîî Notifications</h4>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Task Completion Alerts</div>
                <div class="small-muted">Show notification when task completes</div>
              </div>
              <label class="switch">
                <input type="checkbox" id="taskAlerts" checked />
                <span class="slider"></span>
              </label>
            </div>

            <div class="setting-item">
              <div>
                <div style="font-weight:700">Error Notifications</div>
                <div class="small-muted">Alert on scraping errors</div>
              </div>
              <label class="switch">
                <input type="checkbox" id="errorAlerts" checked />
                <span class="slider"></span>
              </label>
            </div>
          </div>

          <div class="settings-group">
            <h4>üóÑÔ∏è Data Management</h4>
            <div style="display:flex;gap:12px;flex-wrap:wrap">
              <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
              <button class="btn btn-ghost" onclick="exportAllData()">üì• Export All Data</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </main>

  <!-- MODALS -->

  <!-- MODAL: CREATE TASK -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden>
    <div class="modal">
      <h3>Create Scraping Task</h3>
      <div class="small-muted">Fill the task details below</div>
      <div style="height:12px"></div>

      <div class="form-row">
        <div class="col">
          <label class="small-muted">Task Type</label>
          <select id="modalTaskType" class="input">
            <option value="profile">Profile Info</option>
            <option value="posts">Profile Posts</option>
            <option value="hashtag">Hashtag Posts</option>
            <option value="followers">Followers List</option>
            <option value="following">Following List</option>
            <option value="comments">Post Comments</option>
            <option value="likes">Post Likes</option>
          </select>
        </div>

        <div class="col">
          <label class="small-muted">Max Items</label>
          <input id="modalMax" type="number" min="1" max="1000" value="50" class="input" />
        </div>
      </div>

      <div class="form-row">
        <div class="col">
          <label class="small-muted">Target (username or hashtag)</label>
          <input id="modalTarget" class="input" placeholder="elonmusk or technology" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn btn-ghost" id="modalCancel">Cancel</button>
        <button class="btn btn-primary" id="modalCreate">Create Task</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ADD ACCOUNT -->
  <div class="modal-backdrop" id="modalAccount" aria-hidden>
    <div class="modal">
      <h3>Add Instagram Account</h3>
      <div class="small-muted">Add account credentials to run tasks</div>
      <div style="height:12px"></div>

      <div class="form-row">
        <div class="col">
          <label class="small-muted">Username</label>
          <input id="accUser" class="input" placeholder="username" />
        </div>

        <div class="col">
          <label class="small-muted">Password</label>
          <input id="accPass" type="password" class="input" placeholder="password" />
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn btn-ghost" id="accCancel">Cancel</button>
        <button class="btn btn-primary" id="accCreate">Add Account</button>
      </div>
    </div>
  </div>

  <!-- MODAL: TASK DETAIL -->
  <div class="modal-backdrop" id="modalTaskDetail" aria-hidden>
    <div class="modal">
      <div class="task-detail">
        <div class="header">
          <div>
            <h3 style="margin:0" id="taskDetailTitle">Task Details</h3>
            <p class="small-muted" id="taskDetailInfo" style="margin:4px 0 0 0"></p>
          </div>
          <button class="btn btn-ghost" onclick="closeModal('modalTaskDetail')">√ó</button>
        </div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
          <div class="card" style="padding:12px;text-align:center">
            <div class="small-muted">Status</div>
            <div style="font-weight:800;margin-top:4px" id="detailStatus">-</div>
          </div>

          <div class="card" style="padding:12px;text-align:center">
            <div class="small-muted">Items Scraped</div>
            <div style="font-weight:800;margin-top:4px" id="detailItems">-</div>
          </div>

          <div class="card" style="padding:12px;text-align:center">
            <div class="small-muted">Type</div>
            <div style="font-weight:800;margin-top:4px" id="detailType">-</div>
          </div>
        </div>

        <h4>Scraped Data Preview</h4>
        <div class="data-preview" id="dataPreview">Loading...</div>

        <div style="margin-top:20px;display:flex;gap:12px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="exportCurrentTask('json')">üì• Export JSON</button>
          <button class="btn btn-primary" onclick="exportCurrentTask('csv')">üì• Export CSV</button>
          <button class="btn btn-danger" onclick="deleteCurrentTask()">üóëÔ∏è Delete Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- TOASTER -->
  <div id="toaster" style="position:fixed;right:20px;bottom:20px;z-index:80"></div>

  <!-- JAVASCRIPT -->
  <script>
    // Configuration - FIXED: Set to current origin
    const API_BASE = window.location.origin;
    const API_KEY = '';

    // App State
    const store = {
      accounts: [],
      tasks: [],
      results: [],
      stats: {},
      currentTaskId: null
    };

    // Utilities
    const q = (s) => document.querySelector(s);
    const all = (s) => Array.from(document.querySelectorAll(s));

    function toast(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = 'card';
      el.style.padding = '12px 16px';
      el.style.marginTop = '10px';
      el.style.minWidth = '220px';
      el.style.boxShadow = '0 8px 30px rgba(16,24,40,0.08)';
      el.innerHTML = `<strong style="display:block;margin-bottom:6px">${type === 'error' ? '‚ùå' : type === 'info' ? '‚ÑπÔ∏è' : type === 'success' ? '‚úÖ' : '‚ö†Ô∏è'} ${type === 'error' ? 'Error' : type === 'info' ? 'Info' : type === 'success' ? 'Success' : 'Error'}</strong><div style="font-size:13px;color:${type === 'error' ? '#b42323' : '#475569'}">${msg}</div>`;
      toaster.appendChild(el);
      setTimeout(() => el.style.opacity = '0', 3200);
      setTimeout(() => el.remove(), 4000);
    }

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    // API Calls - FIXED: Handle Flask response format correctly
    async function apiCall(endpoint, options = {}) {
      try {
        const headers = { 'Content-Type': 'application/json' };
        if (API_KEY) headers['X-API-Key'] = API_KEY;

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers: { ...headers, ...options.headers }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `API Error: ${response.statusText}`);
        }

        return await response.json();
      } catch (error) {
        console.error('API Call failed:', error);
        toast(error.message, 'error');
        throw error;
      }
    }

    async function fetchStats() {
      const data = await apiCall('/api/stats');
      store.stats = data;
      return data;
    }

    async function fetchTasks(status = null) {
      const endpoint = status ? `/api/tasks?status=${status}` : `/api/tasks`;
      const data = await apiCall(endpoint);
      // FIXED: Flask returns array directly for tasks
      store.tasks = Array.isArray(data) ? data : [];
      return store.tasks;
    }

    async function fetchAccounts() {
      const data = await apiCall('/api/accounts');
      // FIXED: Flask returns array directly (wrapped in accounts)
      console.log('Accounts response:', data);
      store.accounts = Array.isArray(data) ? data : (data.accounts || []);
      return store.accounts;
    }

    async function createTaskAPI(taskData) {
      const data = await apiCall('/api/tasks', { method: 'POST', body: JSON.stringify(taskData) });
      if (data.success) toast(data.message || 'Task created successfully', 'success');
      return data;
    }

    async function addAccountAPI(accountData) {
      const data = await apiCall('/api/accounts', { method: 'POST', body: JSON.stringify(accountData) });
      if (data.success) toast('Account added successfully', 'success');
      return data;
    }

    async function exportTaskData(taskId, format = 'json') {
      const endpoint = `/api/tasks/${taskId}/export/${format}`;
      window.open(`${API_BASE}${endpoint}`, '_blank');
      toast(`Exporting task ${taskId} as ${format.toUpperCase()}`, 'info');
    }

    async function cancelTask(taskId) {
      const data = await apiCall(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
      if (data.success) toast('Task cancelled', 'success');
      return data;
    }

    // Page Navigation
    async function navigateTo(section) {
      all('.page-section').forEach(page => page.classList.remove('active'));
      const targetPage = q(`#page-${section}`);
      if (targetPage) targetPage.classList.add('active');

      all('.nav a').forEach(link => link.classList.remove('active'));
      const activeLink = q(`.nav a[data-section="${section}"]`);
      if (activeLink) activeLink.classList.add('active');

      switch (section) {
        case 'dashboard': renderDashboard(); break;
        case 'scraper':
          await renderScraperPage();
          populateFbidDropdown(); // Update dropdown when entering page
          break;
        case 'accounts': renderAccountsPage(); break;
        case 'tasks': renderTasksPage(); break;
        case 'settings': loadSettings(); break;
      }
    }

    // Dashboard Rendering
    function renderKPIs() {
      kpiAccounts.textContent = store.stats.total_accounts || 0;
      kpiActive.textContent = store.stats.running_tasks || 0;
      kpiCompleted.textContent = store.stats.completed_tasks || 0;
      kpiTotal.textContent = store.stats.total_tasks || 0;
    }

    function renderRecentTasks() {
      const el = recentList;
      el.innerHTML = '';

      if (!store.tasks || store.tasks.length === 0) {
        el.innerHTML = '<div class="small-muted">No recent tasks</div>';
        return;
      }

      const list = store.tasks.slice().sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 6);
      list.forEach(t => {
        const row = document.createElement('div');
        row.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:10px;background:linear-gradient(90deg,#fff,#fbfbfb);cursor:pointer';
        row.onclick = () => viewTaskDetails(t.id);

        const statusClass = t.status === 'completed' ? 's-success' : (t.status === 'running' ? 's-running' : (t.status === 'pending' ? 's-pending' : 's-failed'));

        row.innerHTML = `
          <div>
            <div style="font-weight:700">${t.target.startsWith('#') ? t.target : '@' + t.target}</div>
            <div class="small-muted" style="font-size:12px">${t.task_type} ‚Ä¢ ${formatDate(t.created_at)}</div>
          </div>
          <div>
            <div class="status ${statusClass}">${t.status}</div>
          </div>`;
        el.appendChild(row);
      });
    }

    let page = 1;
    const pageSizeSelect = q('#rowsPerPage');

    function renderTable() {
      const tbody = q('#resultsTable tbody');
      tbody.innerHTML = '';

      if (!store.tasks || store.tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="empty">No tasks yet. Create your first task!</td></tr>';
        tableInfo.textContent = 'Showing 0 of 0';
        return;
      }

      const perPage = parseInt(pageSizeSelect.value, 10);
      const start = (page - 1) * perPage;
      const pageData = store.tasks.slice(start, start + perPage);

      pageData.forEach((t, idx) => {
        const tr = document.createElement('tr');
        tr.style.cursor = 'pointer';
        tr.onclick = () => viewTaskDetails(t.id);

        const statusClass = t.status === 'completed' ? 's-success' : (t.status === 'running' ? 's-running' : (t.status === 'pending' ? 's-pending' : 's-failed'));

        tr.innerHTML = `
          <td>${start + idx + 1}</td>
          <td style="font-weight:700">${t.target}</td>
          <td>${t.task_type}</td>
          <td><span class="status ${statusClass}">${t.status}</span></td>
          <td>${formatDate(t.created_at)}</td>
          <td>
            <div class="actions-row">
              <div class="icon-btn" title="View Data" onclick="event.stopPropagation();viewTaskDetails(${t.id})">üëÅÔ∏è</div>
              <div class="icon-btn" title="Export CSV" onclick="event.stopPropagation();exportTaskData(${t.id}, 'csv')">üì•</div>
              <div class="icon-btn" title="Export JSON" onclick="event.stopPropagation();exportTaskData(${t.id}, 'json')">üìÑ</div>
              ${t.status === 'running' ? `<div class="icon-btn" title="Cancel" onclick="event.stopPropagation();cancelTaskHandler(${t.id})">‚ùå</div>` : ''}
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      const total = store.tasks.length;
      const showing = Math.min(start + perPage, total);
      tableInfo.textContent = `Showing ${showing} of ${total}`;
    }

    function renderAccountsPanel() {
      const el = accountsPanel;
      if (!store.accounts || store.accounts.length === 0) {
        el.innerHTML = '<div class="small-muted">No accounts connected</div>';
        return;
      }

      el.innerHTML = store.accounts.map(a => {
        const statusColor = a.is_active ? '#0f6b2e' : '#8a8a8a';
        const statusText = a.is_active ? 'Active' : 'Inactive';
        return `<div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f3f6">
          <div>
            <div style="font-weight:700">@${a.username}</div>
            <div class="small-muted" style="font-size:11px">Tasks: ${a.tasks_completed || 0}</div>
          </div>
          <div style="color:${statusColor};font-weight:700;font-size:12px">${statusText}</div>
        </div>`;
      }).join('');
    }

    async function renderDashboard() {
      try {
        await Promise.all([fetchStats(), fetchTasks(), fetchAccounts()]);
        renderKPIs();
        renderRecentTasks();
        renderTable();
        renderAccountsPanel();
      } catch (error) {
        console.error('Error rendering dashboard:', error);
      }
    }

    // Scraper Page
    async function renderScraperPage() {
      const activity = scraperActivity;
      if (!store.tasks || store.tasks.length === 0) {
        activity.innerHTML = '<div class="empty">No recent scraping activity</div>';
        return;
      }

      const recent = store.tasks.slice().sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 10);
      activity.innerHTML = recent.map(t => {
        const statusClass = t.status === 'completed' ? 's-success' : (t.status === 'running' ? 's-running' : (t.status === 'pending' ? 's-pending' : 's-failed'));
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #f1f3f6;cursor:pointer" onclick="viewTaskDetails(${t.id})">
          <div>
            <div style="font-weight:700">${t.target}</div>
            <div class="small-muted">${t.task_type} ‚Ä¢ ${formatDate(t.created_at)}</div>
          </div>
          <span class="status ${statusClass}">${t.status}</span>
        </div>`;
      }).join('');
    }

    async function quickScrape(type) {
      let target, max;
      switch (type) {
        case 'profile':
          target = profileUsername.value.trim();
          max = 1;
          break;
        case 'posts':
          target = postsUsername.value.trim();
          max = parseInt(postsMax.value) || 20;
          break;
        case 'hashtag':
          target = hashtagTag.value.trim();
          max = parseInt(hashtagMax.value) || 30;
          break;
        case 'followers':
          target = followersUsername.value.trim();
          max = parseInt(followersMax.value) || 100;
          break;
        case 'comments':
          target = commentsUrl.value.trim();
          max = parseInt(commentsMax.value) || 100;
          break;
        case 'likes':
          target = likesUrl.value.trim();
          max = parseInt(likesMax.value) || 200;
          break;
      }

      if (!target) {
        toast('Please enter a target', 'error');
        return;
      }

      try {
        await createTaskAPI({ task_type: type, target: target, max_items: max });
        switch (type) {
          case 'profile': profileUsername.value = ''; break;
          case 'posts': postsUsername.value = ''; break;
          case 'hashtag': hashtagTag.value = ''; break;
          case 'followers': followersUsername.value = ''; break;
          case 'comments': commentsUrl.value = ''; break;
          case 'likes': likesUrl.value = ''; break;
        }
        await fetchTasks();
        renderScraperPage();
      } catch (error) {
        console.error('Error creating task:', error);
      }
    }

    async function batchScrape() {
      const text = batchUsernames.value.trim();
      if (!text) {
        toast('Please enter usernames', 'error');
        return;
      }

      const usernames = text.split('\n').map(u => u.trim()).filter(u => u);
      let successCount = 0;
      for (const username of usernames) {
        try {
          await createTaskAPI({ task_type: 'profile', target: username, max_items: 50 });
          successCount++;
        } catch (error) {
          console.error(`Error creating task for ${username}:`, error);
        }
      }

      batchUsernames.value = '';
      toast(`Created ${successCount}/${usernames.length} batch tasks`, 'success');
      await fetchTasks();
      renderScraperPage();
    }

    // Accounts Page - FIXED
    async function renderAccountsPage() {
      await fetchAccounts();
      const container = accountsList;
      console.log('Rendering accounts:', store.accounts);

      if (!store.accounts || store.accounts.length === 0) {
        container.innerHTML = '<div class="card"><div class="empty">No accounts added yet. Click "Add Account" to get started.</div></div>';
        return;
      }

      container.innerHTML = store.accounts.map(acc => {
        const statusColor = acc.is_active ? '#0f6b2e' : '#ff4757';
        const statusText = acc.is_active ? 'Active' : 'Inactive';
        const lastUsed = acc.last_used ? formatDate(acc.last_used) : 'Never';

        return `<div class="account-card fade-in">
          <div class="header">
            <div>
              <h3 style="margin:0">@${acc.username}</h3>
              <p class="small-muted" style="margin:4px 0 0 0">ID: ${acc.id}</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <span style="color:${statusColor};font-weight:700">${statusText}</span>
            </div>
          </div>

          <div class="stats">
            <div class="stat">
              <div class="small-muted">Tasks Completed</div>
              <div style="font-weight:800;font-size:1.2rem">${acc.tasks_completed || 0}</div>
            </div>
            <div class="stat">
              <div class="small-muted">Last Used</div>
              <div style="font-weight:800;font-size:0.9rem">${lastUsed}</div>
            </div>
            <div class="stat">
              <div class="small-muted">Status</div>
              <div style="font-weight:800;font-size:0.9rem">${acc.status || 'available'}</div>
            </div>
          </div>
        </div>`;
      }).join('');
    }

    async function refreshAccounts() {
      toast('Refreshing accounts...', 'info');
      await renderAccountsPage();
    }

    // Tasks Page
    async function renderTasksPage() {
      await fetchTasks();
      const tbody = tasksTableBody;

      if (!store.tasks || store.tasks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">No tasks found</td></tr>';
        return;
      }

      tbody.innerHTML = store.tasks.map((t, idx) => {
        const statusClass = t.status === 'completed' ? 's-success' : (t.status === 'running' ? 's-running' : (t.status === 'pending' ? 's-pending' : 's-failed'));

        return `<tr style="cursor:pointer" onclick="viewTaskDetails(${t.id})">
          <td>${idx + 1}</td>
          <td style="font-weight:700">${t.target}</td>
          <td>${t.task_type}</td>
          <td><span class="status ${statusClass}">${t.status}</span></td>
          <td>${t.account_id || 'N/A'}</td>
          <td>${formatDate(t.created_at)}</td>
          <td>
            <div class="actions-row">
              <div class="icon-btn" title="View" onclick="event.stopPropagation();viewTaskDetails(${t.id})">üëÅÔ∏è</div>
              <div class="icon-btn" title="CSV" onclick="event.stopPropagation();exportTaskData(${t.id}, 'csv')">üì•</div>
              <div class="icon-btn" title="JSON" onclick="event.stopPropagation();exportTaskData(${t.id}, 'json')">üìÑ</div>
              ${t.status === 'running' ? `<div class="icon-btn" title="Cancel" onclick="event.stopPropagation();cancelTaskHandler(${t.id})">‚ùå</div>` : ''}
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    async function filterTasks() {
      const status = taskFilterStatus.value;
      if (status === 'all') await fetchTasks();
      else await fetchTasks(status);
      renderTasksPage();
    }

    async function refreshTasks() {
      toast('Refreshing tasks...', 'info');
      await renderTasksPage();
    }

    // Task Details Modal
    async function viewTaskDetails(taskId) {
      store.currentTaskId = taskId;

      try {
        const taskresponse = await apiCall(`/api/tasks/${taskId}/data`);
        const taskData = taskresponse[0].data;
        const task = store.tasks.find(t => t.id === taskId);

        if (!task) {
          toast('Task not found', 'error');
          return;
        }

        taskDetailTitle.textContent = `Task #${taskId}: ${task.target}`;
        taskDetailInfo.textContent = `${task.task_type} ‚Ä¢ Created ${formatDate(task.created_at)}`;

        const statusClass = task.status === 'completed' ? 's-success' : (task.status === 'running' ? 's-running' : (task.status === 'pending' ? 's-pending' : 's-failed'));

        detailStatus.innerHTML = `<span class="status ${statusClass}">${task.status}</span>`;
        detailItems.textContent = Array.isArray(taskData) ? taskData.length : (taskData ? 1 : 0);
        detailType.textContent = task.task_type;

        const preview = dataPreview;

        if (task.task_type === 'profile' && taskData) {
          const p = Array.isArray(taskData) ? taskData[0] : taskData;

          if (p) {
            const verifiedBadge = p.is_verified ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="#3897f0" style="margin-left:4px;vertical-align:text-bottom"><path d="M12.001 2C6.478 2 2.001 6.478 2.001 12C2.001 17.522 6.478 22 12.001 22C17.522 22 22.001 17.522 22.001 12C22.001 6.478 17.522 2 12.001 2ZM10.001 17.293L6.708 14.001L8.122 12.586L10.001 14.465L15.88 8.586L17.294 10.001L10.001 17.293Z" fill="white"></path><path fill-rule="evenodd" clip-rule="evenodd" d="M12.001 0C5.373 0 0.001 5.373 0.001 12C0.001 18.627 5.373 24 12.001 24C18.627 24 24.001 18.627 24.001 12C24.001 5.373 18.627 0 12.001 0ZM12.001 22C6.478 22 2.001 17.522 2.001 12C2.001 6.478 6.478 2 12.001 2C17.522 2 22.001 6.478 22.001 12C22.001 17.522 17.522 22 12.001 22ZM10.001 17.293L6.708 14.001L8.122 12.586L10.001 14.465L15.88 8.586L17.294 10.001L10.001 17.293Z" fill="#3897f0"></path></svg>' : '';
            const privateBadge = p.is_private ? '<span style="font-size:11px;padding:2px 8px;border-radius:999px;background:#fff7e6;color:#b45309;font-weight:600;border:1px solid #fcd34d;margin-left:8px">Private</span>' : '';

            preview.innerHTML = `
                <div style="background:#fff;border-radius:16px;border:1px solid #e2e8f0;overflow:hidden">
                    <div style="padding:24px;display:flex;gap:20px;align-items:flex-start">
                        <img src="//wsrv.nl/?url=${encodeURIComponent(p.profile_pic_url || '')}&w=150&h=150&fit=cover" alt="${p.username}" 
                             style="width:90px;height:90px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 0 0 1px #e2e8f0;flex-shrink:0"/>
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;flex-wrap:wrap;margin-bottom:4px">
                                <h2 style="margin:0;font-size:20px;font-weight:800;color:#0f172a">${p.full_name || p.username}</h2>
                                ${p.is_verified ? verifiedBadge : ''}
                                ${p.is_private ? privateBadge : ''}
                            </div>
                            <div style="color:#64748b;font-weight:500;margin-bottom:12px">@${p.username}</div>
                            <p style="margin:0;font-size:14px;line-height:1.5;color:#334155;white-space:pre-wrap">${p.biography || ''}</p>
                            ${p.fbid ? `<div style="margin-top:8px;font-size:11px;color:#94a3b8;font-family:monospace">FB ID: ${p.fbid}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);border-top:1px solid #e2e8f0;background:#f8fafc">
                        <div style="padding:16px;text-align:center;border-right:1px solid #e2e8f0">
                            <div style="font-size:20px;font-weight:800;color:#0f172a">${(p.media_count || 0).toLocaleString()}</div>
                            <div style="font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Posts</div>
                        </div>
                        <div style="padding:16px;text-align:center;border-right:1px solid #e2e8f0">
                            <div style="font-size:20px;font-weight:800;color:#0f172a">${(p.follower_count || 0).toLocaleString()}</div>
                            <div style="font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Followers</div>
                        </div>
                        <div style="padding:16px;text-align:center">
                            <div style="font-size:20px;font-weight:800;color:#0f172a">${(p.following_count || 0).toLocaleString()}</div>
                            <div style="font-size:12px;color:#64748b;font-weight:600;text-transform:uppercase;letter-spacing:0.5px">Following</div>
                        </div>
                    </div>

                     <div style="padding:12px;background:#f1f5f9;display:flex;justify-content:center;border-top:1px solid #e2e8f0">
                         <a href="https://instagram.com/${p.username}" target="_blank" style="text-decoration:none;color:#3b82f6;font-weight:600;font-size:14px;display:flex;align-items:center;gap:4px">
                             View Profile on Instagram ‚Üó
                         </a>
                     </div>
                </div>
               `;
          } else {
            preview.innerHTML = '<div class="empty">No profile data available</div>';
          }

        } else if (taskData && (Array.isArray(taskData) ? taskData.length > 0 : true)) {
          // const previewData = Array.isArray(taskData) ? taskData.slice(0, 5) : taskData;
          const items = Array.isArray(taskData) ? taskData : [taskData];
          const html = items.map(u => `
            <div style="display:flex;gap:12px;align-items:center;padding:12px;background:#fff;border:1px solid rgba(16,24,40,0.06);border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.04);margin-bottom:10px">
              <img src="//wsrv.nl/?url=${encodeURIComponent(u.profile_pic_url || '')}" alt="${u.username || ''}" style="width:56px;height:56px;border-radius:50%;object-fit:cover;border:1px solid #eee"/>
              <div style="flex:1;min-width:0">
                <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                  <div style="font-weight:800">${u.full_name || u.username || 'Unknown'}</div>
                  ${typeof u.is_private !== 'undefined' ? `<span style="font-size:12px;padding:4px 8px;border-radius:999px;background:${u.is_private ? '#fff7e6' : '#e6f7ee'};color:${u.is_private ? '#7a5200' : '#0f6b2e'};font-weight:700">${u.is_private ? 'Private' : 'Public'}</span>` : ''}
                </div>
                <div class="small-muted" style="margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">@${u.username || ''}</div>
                ${u.fbid ? `<div style="margin-top:8px;font-size:11px;color:#94a3b8;font-family:monospace">FB ID: ${u.fbid}</div>` : ''}
              </div>
              <a href="https://instagram.com/${u.username || ''}" target="_blank" style="text-decoration:none">
                <button class="btn btn-ghost">üîó Open</button>
              </a>
            </div>
          `).join('');
          preview.innerHTML = html || '<div class="empty">No data available</div>';
        } else {
          preview.innerHTML = '<div class="empty">No data available</div>';
        }

        openModal('modalTaskDetail');
      } catch (error) {
        console.error('Error loading task details:', error);
      }
    }

    function exportCurrentTask(format) {
      if (store.currentTaskId) exportTaskData(store.currentTaskId, format);
    }

    async function deleteCurrentTask() {
      if (!store.currentTaskId) return;
      if (!confirm('Are you sure you want to delete this task and all its data?')) return;
      toast('Delete functionality - contact admin', 'info');
      closeModal('modalTaskDetail');
    }

    // Settings
    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('scraperSettings') || '{}');
      maxPosts.value = settings.maxPosts || 50;
      maxFollowers.value = settings.maxFollowers || 100;
      requestDelay.value = settings.requestDelay || 3;
      tasksPerAccount.value = settings.tasksPerAccount || 5;
      cooldownTime.value = settings.cooldownTime || 5;
      headlessMode.checked = settings.headlessMode !== false;
      autoRetry.checked = settings.autoRetry || false;
      saveScreenshots.checked = settings.saveScreenshots || false;
      taskAlerts.checked = settings.taskAlerts !== false;
      errorAlerts.checked = settings.errorAlerts !== false;
    }

    function saveSettings() {
      const settings = {
        maxPosts: parseInt(maxPosts.value),
        maxFollowers: parseInt(maxFollowers.value),
        requestDelay: parseInt(requestDelay.value),
        tasksPerAccount: parseInt(tasksPerAccount.value),
        cooldownTime: parseInt(cooldownTime.value),
        headlessMode: headlessMode.checked,
        autoRetry: autoRetry.checked,
        saveScreenshots: saveScreenshots.checked,
        taskAlerts: taskAlerts.checked,
        errorAlerts: errorAlerts.checked
      };
      localStorage.setItem('scraperSettings', JSON.stringify(settings));
      toast('Settings saved successfully', 'success');
    }

    function clearAllData() {
      if (!confirm('This will delete ALL tasks and scraped data. Are you sure?')) return;
      toast('Clear all data functionality - contact admin', 'info');
    }

    function exportAllData() {
      toast('Exporting all data...', 'info');
      window.open(`${API_BASE}/api/export/all`, '_blank');
    }

    // Event Handlers
    async function cancelTaskHandler(taskId) {
      if (!confirm('Are you sure you want to cancel this task?')) return;
      try {
        await cancelTask(taskId);
        await renderDashboard();
      } catch (error) {
        console.error('Error cancelling task:', error);
      }
    }

    // Modal helpers
    function openModal(selector) {
      const m = document.querySelector(`#${selector}`);
      if (!m) return;
      m.style.display = 'flex';
      setTimeout(() => m.style.opacity = '1', 10);
      document.body.style.overflow = 'hidden';

      const input = m.querySelector('input,select,textarea');
      if (input) setTimeout(() => input.focus(), 120);
    }

    function closeModal(selector) {
      const m = document.querySelector(`#${selector}`);
      if (!m) return;
      m.style.opacity = '0';
      setTimeout(() => m.style.display = 'none', 220);
      document.body.style.overflow = '';
    }

    function populateFbidDropdown() {
      const select = document.getElementById('fbidSourceTask');
      if (!select) return;

      const previouslySelected = select.value;
      const relevantTypes = ['followers', 'following', 'comments', 'likes', 'profile', 'hashtag', 'posts'];

      // Filter for completed tasks that have data
      const completedTasks = store.tasks.filter(t =>
        t.status === 'completed' && relevantTypes.includes(t.task_type)
      );

      if (completedTasks.length === 0) {
        select.innerHTML = '<option value="">No suitable completed tasks found</option>';
        return;
      }

      select.innerHTML = '<option value="">Select a completed task...</option>' +
        completedTasks.map(t => {
          const date = formatDate(t.created_at);
          // Try to extract count from result string if possible
          let countStr = '';
          if (t.result && typeof t.result === 'string') {
            const match = t.result.match(/(\d+) items?/);
            if (match) countStr = ` (${match[1]} items)`;
          }

          return `<option value="${t.id}">#${t.id} ${t.task_type} - ${t.target}${countStr} - ${date}</option>`;
        }).join('');

      if (previouslySelected) select.value = previouslySelected;
    }

    async function startFbidScraper() {
      const select = document.getElementById('fbidSourceTask');
      const qtyInput = document.getElementById('fbidQty');
      const taskDataId = select.value;
      const maxItems = qtyInput.value ? parseInt(qtyInput.value) : 0;

      if (!taskDataId) {
        toast('Please select a source task', 'error');
        return;
      }

      // Find the target from the source task
      const sourceTask = store.tasks.find(t => t.id == taskDataId);
      const target = sourceTask ? sourceTask.target : 'unknown';

      try {
        await createTaskAPI({
          task_type: 'fbid',
          target: `Enrich: ${target} (#${taskDataId})`,
          task_data_id: parseInt(taskDataId),
          max_items: maxItems
        });
        await renderDashboard();
        toast('FBID Enrichment started', 'success');

        // clear selection
        select.value = '';
        qtyInput.value = '';
      } catch (error) {
        console.error(error);
        toast('Error starting task: ' + error.message, 'error');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Instagram Scraper Pro - Initializing...');
      console.log('API Base:', API_BASE);

      // Navigation
      all('.nav a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const section = a.dataset.section;
          navigateTo(section);
        });
      });

      // Dashboard actions
      refreshBtn?.addEventListener('click', async () => {
        await renderDashboard();
        toast('Refreshed', 'success');
      });

      newTaskBtn?.addEventListener('click', () => openModal('modalBackdrop'));
      newAccountBtn?.addEventListener('click', () => openModal('modalAccount'));
      addAccount?.addEventListener('click', () => openModal('modalAccount'));

      // Quick task creation
      createQuick?.addEventListener('click', async () => {
        const type = quickTaskType.value;
        const target = quickTarget.value.trim();
        const max = parseInt(quickMax.value, 10);

        if (!target) {
          toast('Please enter a target', 'error');
          return;
        }

        try {
          await createTaskAPI({ task_type: type, target: target, max_items: max });
          quickTarget.value = '';
          await renderDashboard();
        } catch (error) {
          console.error('Error creating task:', error);
        }
      });

      // Modal task creation
      modalCancel?.addEventListener('click', () => closeModal('modalBackdrop'));
      modalCreate?.addEventListener('click', async () => {
        const type = modalTaskType.value;
        const target = modalTarget.value.trim();
        const max = parseInt(modalMax.value, 10);

        if (!target) {
          toast('Target required', 'error');
          return;
        }

        try {
          await createTaskAPI({ task_type: type, target: target, max_items: max });
          closeModal('modalBackdrop');
          modalTarget.value = '';
          await renderDashboard();
        } catch (error) {
          console.error('Error creating task:', error);
        }
      });

      // Account modal
      accCancel?.addEventListener('click', () => closeModal('modalAccount'));
      accCreate?.addEventListener('click', async () => {
        const u = accUser.value.trim();
        const p = accPass.value;

        if (!u || !p) {
          toast('Provide username & password', 'error');
          return;
        }

        try {
          await addAccountAPI({ username: u, password: p });
          closeModal('modalAccount');
          accUser.value = '';
          accPass.value = '';
          await renderDashboard();
        } catch (error) {
          console.error('Error adding account:', error);
        }
      });

      // Pagination
      prevPage?.addEventListener('click', () => {
        page = Math.max(1, page - 1);
        renderTable();
      });

      nextPage?.addEventListener('click', () => {
        const perPage = parseInt(pageSizeSelect?.value || 10, 10);
        const maxPage = Math.ceil(store.tasks.length / perPage);
        page = Math.min(maxPage, page + 1);
        renderTable();
      });

      rowsPerPage?.addEventListener('change', () => {
        page = 1;
        renderTable();
      });

      // Global search
      let searchTimer = null;
      globalSearch?.addEventListener('input', async (e) => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(async () => {
          const q = e.target.value.trim().toLowerCase();
          if (!q) {
            await fetchTasks();
            renderTable();
            return;
          }

          const allTasks = await fetchTasks();
          store.tasks = allTasks.filter(t =>
            t.target.toLowerCase().includes(q) ||
            t.task_type.toLowerCase().includes(q)
          );
          page = 1;
          renderTable();
        }, 300);
      });

      // Quick filters
      all('[data-filter]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const filter = e.target.dataset.filter;
          if (filter === 'all') await fetchTasks();
          else await fetchTasks(filter);
          page = 1;
          renderTable();
          renderRecentTasks();
        });
      });

      openFullTask?.addEventListener('click', () => openModal('modalBackdrop'));
      manageAccounts?.addEventListener('click', () => navigateTo('accounts'));

      // Auto-refresh for running tasks
      setInterval(async () => {
        if (store.stats.running_tasks > 0) {
          const currentPage = q('.page-section.active')?.id.replace('page-', '');
          if (currentPage === 'dashboard') await renderDashboard();
        }
      }, 10000); // Refresh every 10 seconds

      // Initial load
      renderDashboard();

      console.log('‚úÖ Instagram Scraper Pro initialized successfully!');
      console.log('Debug: window.app available');
    });

    // Expose for debugging
    window.app = { store, renderDashboard, navigateTo, apiCall, fetchTasks, fetchAccounts, fetchStats, API_BASE };
  </script>
</body>

</html>